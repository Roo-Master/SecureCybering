<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Gossip — Peer Interaction & Reputation</title>
    <style>
         :root {
            --bg: #f6f8fa;
            --card: #fff;
            --muted: #666;
            --accent: #2563eb;
            --good: #10b981;
            --bad: #ef4444;
            --neutral: #f59e0b;
        }
        
        body {
            font-family: Inter, Arial, Helvetica, sans-serif;
            background: var(--bg);
            margin: 0;
            padding: 20px;
            color: #111
        }
        
        .wrap {
            max-width: 1100px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 320px 1fr 360px;
            gap: 18px
        }
        
        .card {
            background: var(--card);
            border-radius: 10px;
            padding: 14px;
            box-shadow: 0 4px 12px rgba(15, 23, 42, 0.06)
        }
        
        h1 {
            margin: 0 0 10px;
            font-size: 20px
        }
        
        h2 {
            margin: 0 0 10px;
            font-size: 16px
        }
        
        label {
            font-size: 13px;
            color: var(--muted)
        }
        
        input,
        select,
        textarea,
        button {
            font-family: inherit
        }
        
        input[type=text],
        select,
        textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #e6e9ee;
            border-radius: 6px;
            margin-top: 6px
        }
        
        button {
            padding: 8px 10px;
            border-radius: 8px;
            border: none;
            background: var(--accent);
            color: white;
            cursor: pointer
        }
        
        .muted {
            color: var(--muted);
            font-size: 13px
        }
        
        .peer-list {
            max-height: 420px;
            overflow: auto;
            margin-top: 10px
        }
        
        .peer {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            border-radius: 8px;
            border: 1px solid #f1f3f5;
            margin-bottom: 8px
        }
        
        .avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700
        }
        
        .badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 12px
        }
        
        .badge.red {
            background: var(--bad);
            color: white
        }
        
        .badge.green {
            background: var(--good);
            color: white
        }
        
        .badge.gold {
            background: gold;
            color: #111
        }
        
        .friend-actions {
            margin-left: auto;
            display: flex;
            gap: 6px
        }
        
        .small {
            font-size: 12px;
            padding: 6px 8px
        }
        
        .reports-list {
            max-height: 280px;
            overflow: auto;
            margin-top: 8px
        }
        
        .report {
            border: 1px solid #f3f4f6;
            padding: 8px;
            border-radius: 8px;
            margin-bottom: 8px
        }
        
        .vote-btn {
            background: #eef2ff;
            border: 1px solid #dbeafe;
            color: #1d4ed8;
            padding: 6px 8px;
            border-radius: 6px
        }
        
        .pill {
            display: inline-block;
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid #eee;
            background: #fafafa
        }
        
        .events {
            max-height: 220px;
            overflow: auto;
            margin-top: 8px;
            font-size: 13px
        }
        
        .info-row {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 8px
        }
        
        .note {
            font-size: 12px;
            color: var(--muted)
        }
        
        .danger {
            color: var(--bad)
        }
        /* Dashboard chart container */
        
        #radarChartContainer {
            margin-top: 20px;
            background: var(--card);
            padding: 14px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(15, 23, 42, 0.06);
        }
        
        .login-title {
            display: flex;
            /* Align logo and title in a row */
            align-items: center;
            /* Vertically center them */
            gap: 15px;
            /* Space between logo and title */
            padding: 20px;
            background-color: #f7f7f7;
            /* Light background */
            border-radius: 10px;
            /* Rounded corners */
            /* Subtle border */
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            /* Soft shadow */
        }
        
        .header-logo {
            height: 50px;
            /* Set a consistent logo height */
            width: auto;
            /* Maintain aspect ratio */
        }
        
        .login-title h1 {
            font-size: 1.8rem;
            font-weight: 700;
            color: #222;
            margin: 0;
        }
        
        .logout-btn {
            padding: 10px 20px;
            background-color: #ff4d4f;
            /* Red color for logout */
            color: #fff;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
        }
        
        .logout-btn:hover {
            background-color: #ff7875;
            transform: scale(1.05);
            /* Slight grow effect */
        }
        
        .logout-btn:active {
            transform: scale(0.98);
            /* Pressed effect */
        }
    </style>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div style="max-width:1100px;margin:0 auto 18px;">

        <div class="login-title">
            <img src="securechain.png" alt="Logo" class="header-logo">
            <h1>Gossip Hub</h1>
            <button class="logout-btn">Logout</button>

        </div>

    </div>

    <div class="wrap">
        <!-- LEFT: Peers / Create / Active Peer / Notifications -->
        <div class="card">
            <h2>Peers & Active User</h2>

            <div class="info-row">
                <label for="activePeer">Active Peer</label>
                <select id="activePeer" style="width:100%;margin-top:6px"></select>
            </div>

            <div style="display:flex;gap:8px;margin-top:10px">
                <input id="newPeerName" type="text" placeholder="New peer name" />
                <button id="createPeerBtn">Create</button>
            </div>
            <div class="note">When simulating, create multiple peers then switch <strong>Active Peer</strong> to play as that user.</div>

            <h2 style="margin-top:12px">Peer List</h2>
            <div class="peer-list" id="peerList"></div>

            <h2 style="margin-top:12px">Friend Requests</h2>
            <div id="requestsBox" class="muted">No requests</div>

            <h2 style="margin-top:12px">Notifications</h2>
            <div id="notificationsBox" class="events"></div>
        </div>

        <!-- CENTER: Chat, Messaging, Reports, Dashboard -->
        <div class="card" style="overflow-y:auto; max-height: 95vh;">
            <div style="display:flex;align-items:center;justify-content:space-between">
                <h2>Chat & Reports</h2>
                <div class="pill" id="reputationDisplay">Reputation: --</div>
            </div>

            <div style="display:flex;gap:12px;margin-top:8px">
                <div style="flex:1">
                    <label>Friends</label>
                    <select id="chatFriend" style="margin-top:6px"></select>
                </div>
                <div style="width:160px">
                    <label>Quick Actions</label>
                    <div style="display:flex;gap:6px;margin-top:6px">
                        <button id="sendTestMsg" class="small">Send SMS (stub)</button>
                        <button id="syncBtn" class="small">Sync (stub)</button>
                    </div>
                </div>
            </div>

            <div class="chat-area" style="margin-top:8px">
                <div class="messages" id="messages"></div>

                <div class="controls">
                    <input id="messageText" type="text" placeholder="Type a message..." />
                    <button id="sendMsgBtn">Send</button>
                </div>
            </div>

            <h2 style="margin-top:12px">Report a Peer</h2>
            <div style="display:flex;gap:8px">
                <select id="reportTarget" style="flex:1"></select>
                <button id="createReportBtn" class="small">Create Report</button>
            </div>
            <textarea id="reportDesc" rows="2" placeholder="Describe what happened (scam details)..." style="margin-top:8px; width:100%;"></textarea>

            <h2 style="margin-top:12px">Open Reports</h2>
            <div class="reports-list" id="reportsList"></div>

            <!-- Radar Chart Dashboard -->
            <div id="radarChartContainer">
                <h2>Reputation Dashboard</h2>
                <canvas id="radarChart"></canvas>
            </div>

        </div>

        <!-- RIGHT: Peer Details & Events -->
        <div class="card">
            <h2>Active Peer Details</h2>
            <div id="activeDetails"></div>

            <h2 style="margin-top:12px">Events & Ledger</h2>
            <div class="events" id="eventsList"></div>

            <h2 style="margin-top:12px">Rules & Thresholds</h2>
            <div class="note">
                <ul>
                    <li>Default reputation: <strong>50</strong></li>
                    <li>Majority "Fraud" vote → accused −10, reporter +5</li>
                    <li>Majority "Not Fraud" vote → accused +5, reporter −5</li>
                    <li>Below <strong>+5</strong> → <span class="danger">Marked RED (Fraud)</span></li>
                    <li>70 and above → <span style="color:gold">Most Loyal (Loyalty Card)</span></li>
                </ul>
            </div>

        </div>
    </div>

    <script>
        // -------------------- Utility --------------------
        function uid(prefix = 'id') {
            return prefix + '_' + Math.random().toString(36).slice(2, 9)
        }

        function nowISO() {
            return new Date().toISOString()
        }

        function save(key, val) {
            localStorage.setItem(key, JSON.stringify(val))
        }

        function load(key, fallback) {
            return JSON.parse(localStorage.getItem(key) || JSON.stringify(fallback))
        }

        // -------------------- Notification logic --------------------
        let notifications = load('notifications', []);

        function pushNotification(message) {
            notifications.unshift({
                id: uid('note'),
                text: message,
                at: nowISO()
            });
            if (notifications.length > 200) notifications.pop();
            save('notifications', notifications);
        }

        // -------------------- App state --------------------
        let peers = load('peers', {});
        let friendships = load('friendships', []);
        let messages = load('messages', []);
        let reports = load('reports', []);
        let events = load('events', []);
        let activePeerId = load('activePeerId', null);

        const CONF = {
            startReputation: 50,
            fraudPenalty: 10,
            reporterReward: 5,
            falseReportPenalty: 5,
            trueReportAccusedReward: 5,
            fraudThreshold: 5,
            loyaltyThreshold: 70
        };

        // -------------------- Initialization --------------------
        function saveAll() {
            save('peers', peers);
            save('friendships', friendships);
            save('messages', messages);
            save('reports', reports);
            save('events', events);
            save('notifications', notifications);
        }

        function ensureDemoData() {
            if (Object.keys(peers).length === 0) {
                createPeer('Alice');
                createPeer('Bob');
                createPeer('Carol');
                createPeer('Dave');
                createPeer('Eve');
            }
            if (!activePeerId) {
                activePeerId = Object.keys(peers)[0];
            }
            saveAll();
        }

        // -------------------- Peer mgmt --------------------
        function createPeer(name) {
            const id = uid('peer');
            const color = randomColorFromName(name);
            peers[id] = {
                id,
                name,
                color,
                reputation: CONF.startReputation,
                loyaltyCard: false
            };
            logEvent({
                type: 'peer_created',
                by: id,
                name
            });
            saveAll();
            renderUI();
            return id;
        }

        function updatePeerReputation(peerId, delta) {
            const p = peers[peerId];
            if (!p) return;
            p.reputation = Math.round((p.reputation || 0) + delta);
            if (p.reputation < -100) p.reputation = -100;
            if (p.reputation > 999) p.reputation = 999;
            if (p.reputation >= CONF.loyaltyThreshold && !p.loyaltyCard) {
                p.loyaltyCard = true;
                logEvent({
                    type: 'loyalty_awarded',
                    peerId,
                    at: nowISO()
                });
            }
            if (p.reputation < CONF.fraudThreshold) {
                logEvent({
                    type: 'flagged_fraud',
                    peerId,
                    reputation: p.reputation,
                    at: nowISO()
                });
            }
            saveAll();
            renderUI();
        }

        function randomColorFromName(name) {
            const colors = ['#ef4444', '#f97316', '#f59e0b', '#10b981', '#06b6d4', '#3b82f6', '#7c3aed', '#ec4899'];
            let s = 0;
            for (let ch of name) s += ch.charCodeAt(0);
            return colors[s % colors.length];
        }

        function peerBadge(peer) {
            if (peer.reputation < CONF.fraudThreshold) return {
                label: 'FRAUD',
                cls: 'red'
            };
            if (peer.reputation >= CONF.loyaltyThreshold) return {
                label: 'LOYAL',
                cls: 'gold'
            };
            if (peer.reputation >= 55) return {
                label: 'TRUSTED',
                cls: 'green'
            };
            return {
                label: 'NORMAL',
                cls: ''
            };
        }

        // -------------------- Logging & Events --------------------
        function logEvent(obj) {
            const e = Object.assign({
                id: uid('ev'),
                at: nowISO()
            }, obj);
            events.unshift(e);
            if (events.length > 1000) events.pop();
            pushNotification("Event: " + obj.type + " | " + JSON.stringify(obj));
        }

        // -------------------- Friendship --------------------
        function areFriends(a, b) {
            return friendships.some(f => ((f.requesterId === a && f.targetId === b) || (f.requesterId === b && f.targetId === a)) && f.status === 'accepted');
        }

        function sendFriendRequest(fromId, toId) {
            if (!fromId || !toId || fromId === toId) return;
            const exists = friendships.find(f => (f.requesterId === fromId && f.targetId === toId) || (f.requesterId === toId && f.targetId === fromId));
            if (exists) return alert('Friend request or friendship already exists.');
            const req = {
                id: uid('req'),
                requesterId: fromId,
                targetId: toId,
                status: 'pending',
                createdAt: nowISO()
            };
            friendships.push(req);
            logEvent({
                type: 'friend_request',
                from: fromId,
                to: toId,
                at: nowISO()
            });
            saveAll();
            renderUI();
        }

        function acceptFriendRequest(reqId) {
            const req = friendships.find(r => r.id === reqId);
            if (!req) return;
            req.status = 'accepted';
            logEvent({
                type: 'friend_accept',
                reqId,
                at: nowISO()
            });
            saveAll();
            renderUI();
        }

        function rejectFriendRequest(reqId) {
            const req = friendships.find(r => r.id === reqId);
            if (!req) return;
            req.status = 'rejected';
            logEvent({
                type: 'friend_reject',
                reqId,
                at: nowISO()
            });
            saveAll();
            renderUI();
        }

        // -------------------- Messaging --------------------
        function sendMessage(fromId, toId, text) {
            if (!text || !fromId || !toId) return;
            const msg = {
                id: uid('m'),
                fromId,
                toId,
                text,
                createdAt: nowISO()
            };
            messages.push(msg);
            logEvent({
                type: 'message',
                from: fromId,
                to: toId,
                text,
                at: nowISO()
            });
            saveAll();
            renderUI();
        }

        // -------------------- Reporting & Voting --------------------
        function createReport(reporterId, targetId, description) {
            if (!reporterId || !targetId) return alert('Select a target to report.');
            if (reporterId === targetId) return alert('You cannot report yourself.');

            const rpt = {
                id: uid('rpt'),
                reporterId,
                targetId,
                description: description || '',
                createdAt: nowISO(),
                votes: {},
                resolved: false,
                result: null
            };
            reports.push(rpt);
            logEvent({
                type: 'report_created',
                rptId: rpt.id,
                reporterId,
                targetId,
                at: nowISO(),
                description
            });
            pushNotification(`${peers[reporterId].name} REPORTED ${peers[targetId].name} for FRAUD.`);
            saveAll();
            renderUI();
        }

        function castVote(reportId, voterId, vote) {
            const rpt = reports.find(r => r.id === reportId);
            if (!rpt) return;
            if (rpt.reporterId === voterId) return alert('Reporter cannot vote on their own report.');
            if (rpt.votes[voterId]) return alert('You have already voted on this report.');

            rpt.votes[voterId] = vote; // 'fraud' or 'not'
            logEvent({
                type: 'vote_cast',
                reportId,
                voterId,
                vote,
                at: nowISO()
            });
            pushNotification(`${peers[voterId].name} voted "${vote.toUpperCase()}" on report against ${peers[rpt.targetId].name}.`);
            saveAll();
            evaluateReportIfReady(rpt);
            renderUI();
        }

        function evaluateReportIfReady(rpt) {
            const votes = Object.values(rpt.votes);
            if (votes.length < 1) return;
            const fraudCount = votes.filter(v => v === 'fraud').length;
            const notCount = votes.filter(v => v === 'not').length;
            const peersCount = Object.keys(peers).length;
            const ready = (votes.length >= 3) || (votes.length > Math.max(1, Math.floor(peersCount / 2)));
            if (!ready) return;

            rpt.resolved = true;
            if (fraudCount > notCount) {
                rpt.result = 'fraud';
                updatePeerReputation(rpt.targetId, -CONF.fraudPenalty);
                updatePeerReputation(rpt.reporterId, CONF.reporterReward);
                logEvent({
                    type: 'report_resolved',
                    reportId: rpt.id,
                    result: 'fraud',
                    at: nowISO()
                });
                pushNotification(`REPORT RESOLVED: ${peers[rpt.targetId].name} CONFIRMED as FRAUD.`);
            } else {
                rpt.result = 'not';
                updatePeerReputation(rpt.targetId, CONF.trueReportAccusedReward);
                updatePeerReputation(rpt.reporterId, -CONF.falseReportPenalty);
                logEvent({
                    type: 'report_resolved',
                    reportId: rpt.id,
                    result: 'not',
                    at: nowISO()
                });
                pushNotification(`REPORT RESOLVED: ${peers[rpt.targetId].name} declared NOT fraudulent.`);
            }
            saveAll();
            renderUI();
        }

        // -------------------- UI render --------------------
        function escapeHtml(s) {
            return String(s || '').replace(/[&<>"']/g, m => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            })[m]);
        }

        function renderUI() {
            // Active peer select
            const sel = document.getElementById('activePeer');
            sel.innerHTML = '';
            Object.values(peers).forEach(p => {
                const o = document.createElement('option');
                o.value = p.id;
                o.textContent = p.name;
                if (p.id === activePeerId) o.selected = true;
                sel.appendChild(o);
            });

            // Peer list
            const pl = document.getElementById('peerList');
            pl.innerHTML = '';
            Object.values(peers).forEach(p => {
                const div = document.createElement('div');
                div.className = 'peer';
                const av = document.createElement('div');
                av.className = 'avatar';
                av.style.background = p.color;
                av.textContent = p.name.slice(0, 2).toUpperCase();
                const body = document.createElement('div');
                body.style.flex = '1';
                const name = document.createElement('div');
                name.innerHTML = `<strong>${p.name}</strong> <span class="muted">(${p.id})</span>`;
                const rep = peerBadge(p);
                const repLine = document.createElement('div');
                repLine.style.marginTop = '6px';
                repLine.innerHTML = `<span class="muted">Rep: ${p.reputation}</span> &nbsp; <span class="badge ${rep.cls}">${rep.label}</span>`;
                body.appendChild(name);
                body.appendChild(repLine);

                const actions = document.createElement('div');
                actions.className = 'friend-actions';

                // Friend / request button
                const frBtn = document.createElement('button');
                frBtn.className = 'small';
                if (areFriends(activePeerId, p.id)) {
                    frBtn.textContent = 'Friend';
                    frBtn.disabled = true;
                } else {
                    const existing = friendships.find(f => (f.requesterId === activePeerId && f.targetId === p.id) || (f.requesterId === p.id && f.targetId === activePeerId));
                    if (existing && existing.status === 'pending') {
                        if (existing.targetId === activePeerId) {
                            frBtn.textContent = 'Accept';
                            frBtn.onclick = () => acceptFriendRequest(existing.id);
                        } else {
                            frBtn.textContent = 'Pending';
                            frBtn.disabled = true;
                        }
                    } else {
                        frBtn.textContent = 'Add';
                        frBtn.onclick = () => sendFriendRequest(activePeerId, p.id);
                    }
                }
                actions.appendChild(frBtn);

                // Message button (only if friends)
                const msgBtn = document.createElement('button');
                msgBtn.className = 'small';
                msgBtn.textContent = 'Msg';
                if (!areFriends(activePeerId, p.id)) msgBtn.disabled = true;
                msgBtn.onclick = () => {
                    document.getElementById('chatFriend').value = p.id;
                    renderUI();
                };
                actions.appendChild(msgBtn);

                div.appendChild(av);
                div.appendChild(body);
                div.appendChild(actions);
                pl.appendChild(div);
            });

            // Chats
            const chatSel = document.getElementById('chatFriend');
            chatSel.innerHTML = '';
            const frs = Object.values(peers).filter(p => areFriends(activePeerId, p.id) && p.id !== activePeerId);
            if (frs.length === 0) {
                const o = document.createElement('option');
                o.textContent = 'No friends yet';
                o.value = '';
                chatSel.appendChild(o);
            } else {
                frs.forEach(f => {
                    const o = document.createElement('option');
                    o.value = f.id;
                    o.textContent = f.name;
                    chatSel.appendChild(o);
                });
            }

            // Report target select
            const rSel = document.getElementById('reportTarget');
            rSel.innerHTML = '';
            Object.values(peers).filter(p => p.id !== activePeerId).forEach(p => {
                const o = document.createElement('option');
                o.value = p.id;
                o.textContent = p.name + ' (' + p.reputation + ')';
                rSel.appendChild(o);
            });

            // Reports list
            const rbox = document.getElementById('reportsList');
            rbox.innerHTML = '';
            reports.forEach(r => {
                const el = document.createElement('div');
                el.className = 'report';
                const reporter = peers[r.reporterId] ? peers[r.reporterId].name : r.reporterId;
                const target = peers[r.targetId] ? peers[r.targetId].name : r.targetId;
                const votes = Object.entries(r.votes).map(([voter, v]) => `${peers[voter] ? peers[voter].name : voter}:${v}`).join(', ');
                el.innerHTML = `
            <div><strong>${reporter}</strong> reported <strong>${target}</strong> • <span class="muted">${new Date(r.createdAt).toLocaleString()}</span></div>
            <div style="margin-top:6px">${escapeHtml(r.description || '')}</div>
            <div style="margin-top:8px" class="muted">Votes: ${votes || 'none'}</div>
            <div style="margin-top:8px">${r.resolved ? '<strong>Result:</strong> '+r.result : ''}</div>
        `;
                if (!r.resolved && activePeerId !== r.reporterId) {
                    const btnF = document.createElement('button');
                    btnF.textContent = 'Vote Fraud';
                    btnF.className = 'vote-btn';
                    btnF.onclick = () => castVote(r.id, activePeerId, 'fraud');
                    const btnN = document.createElement('button');
                    btnN.textContent = 'Vote Not';
                    btnN.className = 'vote-btn';
                    btnN.style.marginLeft = '8px';
                    btnN.onclick = () => castVote(r.id, activePeerId, 'not');
                    el.appendChild(btnF);
                    el.appendChild(btnN);
                }
                rbox.appendChild(el);
            });

            // Messages
            const msgBox = document.getElementById('messages');
            msgBox.innerHTML = '';
            const partnerId = document.getElementById('chatFriend').value;
            const convo = messages.filter(m => (m.fromId === activePeerId && m.toId === partnerId) || (m.fromId === partnerId && m.toId === activePeerId))
                .sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
            convo.forEach(m => {
                const d = document.createElement('div');
                d.className = 'msg ' + (m.fromId === activePeerId ? 'me' : 'them');
                const who = peers[m.fromId] ? peers[m.fromId].name : m.fromId;
                d.innerHTML = `<div style="font-size:12px;color:var(--muted)">${who} • ${new Date(m.createdAt).toLocaleTimeString()}</div><div style="margin-top:6px">${escapeHtml(m.text)}</div>`;
                msgBox.appendChild(d);
            });

            // Active peer details
            const ad = document.getElementById('activeDetails');
            ad.innerHTML = '';
            const ap = peers[activePeerId];
            if (ap) {
                const av = document.createElement('div');
                av.style.display = 'flex';
                av.style.gap = '10px';
                av.style.alignItems = 'center';
                const a = document.createElement('div');
                a.className = 'avatar';
                a.style.background = ap.color;
                a.textContent = ap.name.slice(0, 2).toUpperCase();
                const meta = document.createElement('div');
                meta.innerHTML = `<div><strong>${ap.name}</strong></div>
                <div class="muted">ID: ${ap.id}</div>
                <div style="margin-top:6px">Reputation: <strong>${ap.reputation}</strong> ${ap.loyaltyCard ? '<span class="badge gold">LOYALTY CARD</span>' : ''}</div>`;
                av.appendChild(a);
                av.appendChild(meta);
                ad.appendChild(av);
            }

            // Events ledger
            const evBox = document.getElementById('eventsList');
            evBox.innerHTML = '';
            events.slice(0, 60).forEach(e => {
                const div = document.createElement('div');
                div.style.borderBottom = '1px dashed #eef2ff';
                div.style.padding = '6px 0';
                div.innerHTML = `<div style="font-size:12px;color:var(--muted)">${new Date(e.at).toLocaleString()}</div><div>${escapeHtml(JSON.stringify(e))}</div>`;
                evBox.appendChild(div);
            });

            // Notifications
            const notifBox = document.getElementById('notificationsBox');
            notifBox.innerHTML = '';
            notifications.slice(0, 60).forEach(n => {
                const div = document.createElement('div');
                div.style.borderBottom = '1px dashed #ddd';
                div.style.padding = '4px 0';
                div.innerHTML = `<div style="font-size:12px;color:var(--muted)">${new Date(n.at).toLocaleTimeString()}</div>
                <div>${escapeHtml(n.text)}</div>`;
                notifBox.appendChild(div);
            });

            // Update reputation badge display for active peer
            const repDisp = document.getElementById('reputationDisplay');
            repDisp.textContent = 'Reputation: ' + (ap ? ap.reputation : '--');

            // Update radar chart
            updateRadarChart();
        }

        // -------------------- Radar Chart --------------------
        let radarChartInstance = null;

        function updateRadarChart() {
            const ctx = document.getElementById('radarChart').getContext('2d');
            const labels = Object.values(peers).map(p => p.name);
            const data = Object.values(peers).map(p => p.reputation);

            const chartData = {
                labels: labels,
                datasets: [{
                    label: 'Peer Reputation',
                    data: data,
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 2,
                    pointBackgroundColor: 'rgba(54, 162, 235, 1)'
                }]
            };

            const config = {
                type: 'radar',
                data: chartData,
                options: {
                    scales: {
                        r: {
                            suggestedMin: 0,
                            suggestedMax: 100
                        }
                    },
                    responsive: true,
                    maintainAspectRatio: false
                }
            };

            if (radarChartInstance) {
                radarChartInstance.data = chartData;
                radarChartInstance.update();
            } else {
                radarChartInstance = new Chart(ctx, config);
            }
        }

        // -------------------- Boot --------------------
        ensureDemoData();
        renderUI();

        // -------------------- UI wiring --------------------
        document.getElementById('createPeerBtn').addEventListener('click', () => {
            const name = document.getElementById('newPeerName').value.trim();
            if (!name) return alert('Peer name required');
            createPeer(name);
            document.getElementById('newPeerName').value = '';
        });

        document.getElementById('activePeer').addEventListener('change', (e) => {
            activePeerId = e.target.value;
            save('activePeerId', activePeerId);
            renderUI();
        });

        document.getElementById('sendMsgBtn').addEventListener('click', () => {
            const text = document.getElementById('messageText').value.trim();
            const toId = document.getElementById('chatFriend').value;
            if (!toId) return alert('Select a friend to send to');
            if (!text) return alert('Enter a message');
            sendMessage(activePeerId, toId, text);
            document.getElementById('messageText').value = '';
        });

        document.getElementById('createReportBtn').addEventListener('click', () => {
            const target = document.getElementById('reportTarget').value;
            const desc = document.getElementById('reportDesc').value.trim();
            createReport(activePeerId, target, desc);
            document.getElementById('reportDesc').value = '';
        });

        document.getElementById('sendTestMsg').addEventListener('click', () => {
            alert('SMS stub (not implemented)');
        });

        document.getElementById('syncBtn').addEventListener('click', () => {
            alert('Sync stub (not implemented)');
        });
        document.querySelector(".logout-btn").addEventListener("click", () => {
            // Clear user session (example)
            localStorage.removeItem("username");
            alert("You have been logged out!");
            window.location.href = "gosip.html"; // Redirect to login page
        });
    </script>
    <script src="auth-and-peer.js"></script>
</body>

</html>
